<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        :root {
            --circle-active: #83d062;
            --circle-inactive: #e2e0df;
            --circle-error: #a80f0f;
            --color-error: #a80f0f;
            --circle-error-lighter: #f32121;
            --color-error-lighter: #f32121;
            --color-inactive: #e2e0df;
            --color-active: black;
        }

        html, body {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
            font-size: 1rem;
            font-family: monospace;
            /*display: flex;*/
            /*justify-content: center;*/

            /*width: 100vw;*/
            /*height: 100vh;*/

            /*margin-top: 5%;*/
        }

        .root-flex-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .root-grid-container {
            display: grid;
            width: 99vw;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: auto auto;
            column-gap: 20px;
            row-gap: 20px;
        }

        .grid-sub-container {
            display: grid;
            grid-template-columns: 50px repeat(4, 1fr);
            grid-template-rows: repeat(8, 30px);
            border: 2px dodgerblue solid;
            border-radius: 10px;
            gap: 3px;
            padding: 5px;
        }

        /*.grid-sub-item {*/
        /*    display: flex;*/
        /*    justify-content: center;*/
        /*    border: 1px black solid;*/
        /*}*/

        /*.container {*/
        /*    display: grid;*/
        /*    width: 1000px;*/
        /*    height: 200px;*/

        /*    grid-template-columns: 50px repeat(4, 1fr);*/
        /*    grid-auto-rows: 50px;*/
        /*    gap: 2px;*/

        /*    font-family: monospace;*/
        /*    font-size: 1.2rem;*/
        /*}*/

        .item {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #b7b8c4  ;
            border: 1px solid black;
            border-radius: 10px;
            transition: color ease-in 500ms;
            padding: 10px;
            /*font-weight: bold;*/
        }

        .circle, .circle-active, .circle-inactive, .circle-error {
            display: flex;
            justify-content: center;
            align-items: center;

        }
        .circle-active > div {
            height: 85%;
            width: 55%;
            border-radius: 50%;
            background-color: var(--circle-active);
            transition: background-color ease-in 500ms;
        }

        .circle-inactive > div {
            height: 85%;
            width: 55%;
            border-radius: 50%;
            background-color: var(--circle-inactive);
            transition: background-color ease-in 500ms;
        }

        .circle-error > div {
            height: 85%;
            width: 55%;
            border-radius: 50%;
            background-color: var(--circle-error);
            transition: background-color ease-in 500ms;
        }

        .table {
            border: 1px solid black;
            border-radius: 5px;
            font-size: 1.1rem;
            padding: 8px;
            /*margin-bottom: 7px;*/

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .color-inactive {
            /*color: var(--color-grey);*/
            color: var(--color-inactive);
        }

        .color-active {
            color: var(--color-active);
            font-weight: bold;
        }

        .color-error {
            color: var(--color-error);
            font-weight: bold;
        }

        .color-error-lighter {
            color: var(--color-error-lighter);
            font-weight: bold;
        }

        .circle-error-lighter > div {
            background-color: var(--circle-error-lighter);
        }

        .timer {
            color: dodgerblue;
        }

    </style>

</head>
<body>

    <div class="root-flex-container">
        <div class="root-grid-container">
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
            <div class="grid-sub-container">
                <div class="table">Инд.</div>
                <div class="table">Сервер</div>
                <div class="table">heartbeat получен</div>
                <div class="table">Статус</div>
                <div class="table">Время Offline&nbsp;<span class="timer">ДД:чч:мм</span></div>
            </div>
        </div>
    </div>

    <script>
        /**
         * @type {HTMLDivElement[]}
         */
        let gridSubContainers = Array.from(
            document.querySelectorAll('.grid-sub-container')
        );

        /**
         *
         * @type {Generator<HTMLDivElement, void, *>}
         */
        const containerGen = nextContainerGen();

        function* nextContainerGen() {
            for (let container of gridSubContainers) {
                while (container.children.length <= 35) {
                    yield container;
                }
            }
        }
    </script>

    <script>
        const ws = new WebSocket(`wss://${location.host}`);
        const expiredObject = {};
        const offlineServers = [];

        const HBStatus = {
            UNDEFINED: 'undefined',
            ACTIVE: 'active',
            INACTIVE: 'inactive'
        };

        /**
         * @typedef {Object} Server
         * @property {string} cn
         * @property {string} name
         * @property {string} objectGUID
         * @property {string} operatingSystem
         * @property {Date|null} timestamp
         * @property {boolean|null} heartbeat
         * @property {string} _id
         */

        ws.addEventListener('message', (e) => {
            /**
             * @type {Server[]}
             */
            const serverObjs = JSON.parse(e.data);

            serverObjs.forEach(server => {
                console.log(server.name);
                const allDivs = searchAllDivs(server.name) || addElements(server);
                if (!allDivs) {
                    console.log(`Для данного ${server.name} нет доступного контейнера для создания уведомления`);
                    return;
                }
                addClassElements(allDivs, server.heartbeat, server.name);
                updateTextEl(allDivs, server);

                if (server.heartbeat === HBStatus.INACTIVE && !expiredObject[server._id]) {
                    flickerDivs(allDivs, server);
                    const offlineTimerToStr = getOfflineTimer(server.timestamp);
                    updateOfflineTextOnDiv(server.name, offlineTimerToStr);
                    offlineServers.push(server);
                } else if (expiredObject[server._id]) {
                    clearInterval(expiredObject[server._id]);
                    delete expiredObject[server._id];
                    delete offlineServers.find(serverOffline => server.name === serverOffline.name);
                }
            })
        })

        /**
         * @param {Server} server
         * @returns {HTMLDivElement[]}
         */
        function addElements(server) {
            console.log(`addElements serrverName: ${server.name}`);

            const elements = [];

            const heartbeatTimestamp = server.timestamp? shortTimestamp(server.timestamp): 'Inactive';
            let hbStatus = 'Online'
            if (server.heartbeat !== HBStatus.ACTIVE) {
                hbStatus = 'Offline'
            }

            const elementsText = {
                0: server.name,
                1: heartbeatTimestamp,
                2: hbStatus,
                3: 'Missing'
            }

            const gen = containerGen.next();

            if (!gen.done) {
                const container = gen.value;
                const divCircle = document.createElement('div');
                const subDivCircle = document.createElement('div');
                divCircle.classList.add('circle');
                divCircle.append(subDivCircle);
                container.append(divCircle);
                elements.push(divCircle);

                for (let i = 0; i < 4; i++) {
                    let div = document.createElement('div');
                    div.textContent = elementsText[i];
                    container.append(div);
                    elements.push(div);
                }
            }
            return elements.length? elements: null;
        }

        /**
         *
         * @param {HTMLDivElement[]} elms
         * @param {boolean|null} heartbeat
         * @param {String} serverName
         * @returns {void}
         */
        function addClassElements(elms, heartbeat, serverName) {
            // const typeStyle = heartbeat === null? 'inactive': heartbeat === true? 'active': 'error';

            const attr = {
                name: 'server-name',
                value: serverName
            };

            const circleActive = `circle circle-active`;
            const circleInActive = `circle circle-inactive`;
            const circleError = `circle circle-error`;

            const divActive = `item grid-sub-item color-active`;
            const divInActive = `item grid-sub-item color-inactive`;
            const divError = `item grid-sub-item color-error`;

            elms.forEach(divEl => {
                divEl.setAttribute(attr.name, attr.value);
                // removeClassOnElement(divEl);

                switch (heartbeat) {
                    case HBStatus.UNDEFINED:
                        if (isCircle(divEl)) {
                            removeClassOnElement(divEl);
                            applyClassOnElement(divEl, circleInActive);
                        } else {
                            removeClassOnElement(divEl);
                            applyClassOnElement(divEl, divInActive);
                            // const classes = divInActive.split(' ');
                            // divEl.classList.add(...classes);
                        }
                        break;
                    case HBStatus.ACTIVE:
                        if (isCircle(divEl)) {
                            removeClassOnElement(divEl);
                            applyClassOnElement(divEl, circleActive);
                        } else {
                            removeClassOnElement(divEl);
                            applyClassOnElement(divEl, divActive);
                        }
                        break;
                    case HBStatus.INACTIVE:
                        if (isCircle(divEl)) {
                            removeClassOnElement(divEl);
                            applyClassOnElement(divEl,circleError);
                        } else {
                            removeClassOnElement(divEl);
                            applyClassOnElement(divEl, divError);
                        }
                        break;
                }
            })
        }

        /**
         * @param {HTMLDivElement} el
         * @param {string} strClass
         * @returns {void}
         */
        function applyClassOnElement(el, strClass) {
            const classes = strClass.split(' ');
            el.classList.add(...classes);
        }

        /**
         *
         * @param {HTMLDivElement} el
         * @returns {Boolean}
         */
        function isCircle(el) {
            return el.classList.contains('circle');
        }

        /**
         * @param {HTMLDivElement} el
         * @returns {void}
         */
        function removeClassOnElement(el) {
            Array.from(el.classList).forEach(cls => {el.classList.remove(cls)});
        }

        /**
         * @param {string} serverName
         * @returns {HTMLDivElement[]|null}
         */
        function searchAllDivs(serverName) {
            const query = `[server-name="${serverName}"]`;
            const elms = document.querySelectorAll(query);
            return elms.length
                      ? Array
                         .from(elms)
                         .map(element =>
                           /** @type {HTMLDivElement} */
                             (element)
                         )
                      : null
        }

        /**
         *
         * @param {HTMLDivElement[]} divs
         * @param srvObj
         */
        function flickerDivs(divs, srvObj) {
            expiredObject[srvObj._id] = setInterval(() => {
                divs.forEach(div => {
                    div.classList.contains('circle')
                        ? div.classList.toggle('circle-error-lighter')
                        : div.classList.toggle('color-error-lighter')
                })
            }, 1000);
        }

        /**
         *
         * @param {Date} timestamp
         * @returns {string}
         */
        function shortTimestamp(timestamp) {
            console.log(`func shortTimestamp value: ${timestamp}`)
            const dateStr = timestamp.toLocaleString();
            return dateStr.replace('T', ' ').slice(0,19);
        }

        /**
         *
         * @param {HTMLDivElement[]} elms
         * @param {Server} server
         */
        function updateTextEl(elms, server) {

            const timestamp = server.timestamp? shortTimestamp(server.timestamp): 'Inactive';
            let hbStatus = 'Online'
            if (server.heartbeat !== HBStatus.ACTIVE) {
                hbStatus = 'Offline'
            }

            const elementsText = {
                1: server.name,
                2: timestamp,
                3: hbStatus,
                4: 'Missing'
            }

            elms.forEach((div, i) => {
                if (div.classList.contains('item')) {
                    div.textContent = elementsText[i];
                }
            })
        }

        /**
         * @param date
         * @returns {number}
         */
        function getTimeDifferenceInMilliseconds(date) {
            const dateNow = new Date();
            date = new Date(date);
            const expLocalDate = new Date(
                date.getUTCFullYear(),
                date.getUTCMonth(),
                date.getUTCDate(),
                date.getUTCHours(),
                date.getUTCMinutes(),
                date.getUTCSeconds(),
                date.getUTCMilliseconds()
            );

            return dateNow - expLocalDate;
        }

        /**
         * @param milliseconds
         * @returns {String}
         */
        function convertMillisecondsInOfflineTimer(milliseconds) {
            const oneDay = 24 * 60 * 60* 1000;
            const oneHour = 60 * 60 * 1000;
            const oneMinute = 60 * 1000;
            // const oneSecond = 1000;

            let days = (Math.floor(milliseconds / oneDay)).toString();
            let hours = (Math.floor(milliseconds % oneDay / oneHour)).toString();
            let minutes = (Math.floor(milliseconds % oneHour / oneMinute)).toString();
            // let seconds = (Math.floor((milliseconds / oneSecond) % 60)).toString();

            days = days.length < 2? '0' + days: days;
            hours = hours.length < 2? '0' + hours: hours;
            minutes = minutes.length < 2? '0' + minutes: minutes;
            // seconds = seconds.length < 2? '0' + seconds: seconds;

            return `${days}:${hours}:${minutes}`;
            // return `Д ${days}:${hours}:${minutes}:${seconds}`;
        }

        /**
         * @param {Date} timestamp
         * @returns {String}
         */
        function getOfflineTimer(timestamp) {
            const milliseconds = getTimeDifferenceInMilliseconds(timestamp);
            return convertMillisecondsInOfflineTimer(milliseconds);
        }

        /**
         * @param {String} serverName
         * @param {String} text
         * @returns {void}
         */
        function updateOfflineTextOnDiv(serverName, text) {
            const allDivs = searchAllDivs(serverName);
            Array.from(allDivs).at(-1).textContent = text;
        }

        function watcherInactiveServer() {
            setInterval(() => {
                offlineServers.forEach(server => {
                    const offlineTimerText = getOfflineTimer(server.timestamp);
                    updateOfflineTextOnDiv(server.name, offlineTimerText);
                })
            }, 5 * 60 * 1000)
        }

        watcherInactiveServer();

    </script>

</body>
</html>